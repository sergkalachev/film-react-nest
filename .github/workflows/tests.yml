name: Tests 15 sprint

on:
  push:
    branches: ['**']
    tags: ['**']

env:
  DIR_TESTS: /tmp/tests-migrate-db
  REP_TESTS: https://github.com/Yandex-Practicum/tests-migrate-db.git

jobs:
  test_backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18.x }
      - name: Get testing lib
        run: set -eu && git clone --depth 1 "$REP_TESTS" "$DIR_TESTS"
      - name: Run tests
        run: bash "$DIR_TESTS/bin/backend.sh"

  test_endpoints:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 18.x }
      - name: Get testing lib
        run: set -eu && git clone --depth 1 "$REP_TESTS" "$DIR_TESTS"

      - name: Prepare backend env
        run: |
          set -euxo pipefail
          cp "$DIR_TESTS/data/.env.example" backend/.env
          sed -i 's|^DATABASE_URL=.*|DATABASE_URL=postgres://postgres:postgres@localhost:5432/films|' backend/.env

      - name: Start Postgres (from tests repo) and wait ready
        run: |
          set -euxo pipefail
          cd "$DIR_TESTS/data"
          docker compose up -d
          for i in {1..60}; do
            docker exec postgres_container pg_isready -U postgres -d films >/dev/null 2>&1 && break || sleep 2
          done
          docker exec postgres_container psql -U postgres -d films -c '\dt' || true

      - name: Build & start backend
        run: |
          set -euxo pipefail
          npm ci --prefix backend
          npm run --prefix backend build
          npm run --prefix backend start:dev &

      - name: Run endpoint tests
        run: |
          npx -y wait-port@1.0.4 -t 120000 3000
          bash "$DIR_TESTS/bin/endpoints.sh"
